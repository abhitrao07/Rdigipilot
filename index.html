<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Jio Creative Generator</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
:root { --blue:#0078ff; --blue-dark:#005fcc; --ok:#137333; }
body { font-family: Arial, sans-serif; margin:30px; text-align:center; }
.container { max-width:900px; margin:auto; }
canvas { border:1px solid #ccc; margin-top:16px; max-width:100%; }
.row { display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-top:10px; }
input, button { padding:10px; font-size:16px; }
button { background:var(--blue); color:#fff; border:none; border-radius:6px; cursor:pointer; }
button:hover { background:var(--blue-dark); }
button[disabled] { opacity:.5; cursor:not-allowed; }
.subhead { color:var(--ok); margin:8px 0; }
.fileline { display:flex; justify-content:center; gap:8px; margin-top:6px; }
.clearX { color:#d11; font-size:18px; cursor:pointer; }
</style>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>

<body>
<div class="container">

<h2>Generate Jio Creative</h2>
<div id="entryCount" class="subhead">Entries: 0</div>

<div class="row">
  <input type="file" id="fileInput" accept=".csv,.xlsx,.xls">
  <button onclick="downloadTemplate()">Download CSV Template</button>
</div>

<div class="fileline" id="fileLine" style="display:none;">
  <span id="fileName"></span>
  <span class="clearX" onclick="clearFile()">Ã—</span>
</div>

<div class="row">
  <input id="manualStore" placeholder="Enter Store Name (if no file)">
</div>

<div class="row">
  <button id="generateBtn" disabled>Generate</button>
</div>

<canvas id="canvas"></canvas>

</div>

<script>

const baseImagePath = "base.jpg";
const STATIC_QR_URL = "https://www.jio.com/selfcare/selfkyc/?utm_campaign=skycSJA&utm_source=creativeQR&utm_medium=Rdigi";

let DATA = [];

const fileInput = document.getElementById("fileInput");
const fileLine  = document.getElementById("fileLine");
const fileName  = document.getElementById("fileName");
const entryCnt  = document.getElementById("entryCount");
const genBtn    = document.getElementById("generateBtn");
const manualStoreInput = document.getElementById("manualStore");

const norm = v => (v||"").toString().replace(/\u00A0/g," ").replace(/\s+/g," ").trim();

function updateUI() {
  entryCnt.textContent = `Entries: ${DATA.length}`;
  const manual = manualStoreInput.value.trim();
  genBtn.disabled = !(DATA.length || manual);
}

fileInput.addEventListener("change", async e => {
  const file = e.target.files[0];
  if (!file) return;

  DATA = [];

  if (file.name.endsWith(".csv")) {
    const text = (await file.text()).replace(/\r/g,"\n");
    const lines = text.split("\n").filter(l => l.trim());

    for (let i = 1; i < lines.length; i++) {
      const parts = lines[i].split(",");
      const store = norm(parts[0]);
      const state = norm(parts[1]);
      if (store && state) DATA.push({ store, state });
    }
  } else {
    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf);
    const ws = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(ws, { defval:"" });

    json.forEach(r => {
      const store = norm(r.store_name || r.store);
      const state = norm(r.state);
      if (store && state) DATA.push({ store, state });
    });
  }

  fileName.textContent = `${file.name} (${DATA.length})`;
  fileLine.style.display = "flex";
  updateUI();
});

manualStoreInput.addEventListener("input", updateUI);

function clearFile() {
  DATA = [];
  fileInput.value = "";
  fileLine.style.display = "none";
  updateUI();
}

genBtn.onclick = async () => {

  // BULK GENERATION
  if (DATA.length) {
    const zip = new JSZip();

    for (const row of DATA) {
      const blob = await drawCreative(row.store);
      const folder = zip.folder(row.state.replace(/[^a-z0-9 ]/gi,"_"));
      const fileSafe = row.store.replace(/[^a-z0-9]/gi,"_");
      folder.file(`${fileSafe}.png`, blob);
    }

    saveAs(await zip.generateAsync({type:"blob"}), "creatives_statewise.zip");
  }

  // SINGLE GENERATION (no upload)
  else {
    const storeName = manualStoreInput.value.trim();
    if (!storeName) return;

    const blob = await drawCreative(storeName);
    saveAs(blob, "creative.png");
  }
};

async function drawCreative(storeName) {
  const img = await loadImage(baseImagePath);
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");

  canvas.width = img.width;
  canvas.height = img.height;
  ctx.drawImage(img,0,0);

  const qrCanvas = document.createElement("canvas");
  await QRCode.toCanvas(qrCanvas, STATIC_QR_URL);

  const qrPx = canvas.width * 0.18;
  const rightMargin = canvas.width * 0.125;
  const bottomMargin = canvas.width * 0.16;

  const x = canvas.width - qrPx - rightMargin;
  const y = canvas.height - qrPx - bottomMargin;

  ctx.drawImage(qrCanvas, x, y, qrPx, qrPx);

  if (storeName) {
    ctx.font = `${canvas.width * 0.025}px Arial`;
    ctx.textAlign = "center";
    ctx.fillText(storeName, x + qrPx/2, y + qrPx + qrPx*0.08);
  }

  return new Promise(r => canvas.toBlob(r));
}

function loadImage(src) {
  return new Promise((res,rej)=>{
    const i = new Image();
    i.onload = () => res(i);
    i.onerror = rej;
    i.src = src;
  });
}

function downloadTemplate() {
  const csv =
`store_name,state
Sharma Mobile Store,Maharashtra
Raj Telecom,Gujarat
ABC Mobiles,Karnataka`;
  saveAs(new Blob([csv],{type:"text/csv"}),"store_state_template.csv");
}

</script>
</body>
</html>
